---
contentKey: chapter
title: Update Chat Screen
stepNo: 8
metaTitle: Update Chat Screen page
metaDescription: Update Chat Screen description
date: 2022-01-25T21:27:17.316Z
duration: 30 min
tags:
  - flutter
  - firebase
keywords:
  - flutter
  - firebase
---
# ðŸ—£ï¸ Update Chat Screen

Now let's finish the Chat application and save the chat message to database.

#### Database Service

We update our **DatabaseService** to getChatMessages and sendChatMessage => database_service.dart  

```
Future<List<Message>> getChatMessages(
      String senderId, String receiverId) async {
    List<Message> messages = [];
    QuerySnapshot messagesSenderQuerySnapshot = await chatsRef
        .where('senderId', isEqualTo: senderId)
        .where('toUserId', isEqualTo: receiverId)
        .orderBy('timestamp', descending: true)
        .get();

    for (var doc in messagesSenderQuerySnapshot.docs) {
      // ignore: avoid_print
      print(doc.id);
      messages.add(Message.fromDoc(doc));
    }
    QuerySnapshot messagestoQuerySnapshot = await chatsRef
        .where('senderId', isEqualTo: receiverId)
        .where('toUserId', isEqualTo: senderId)
        .orderBy('timestamp', descending: true)
        .get();

    for (var doc in messagestoQuerySnapshot.docs) {
      // ignore: avoid_print
      print(doc.id);
      messages.add(Message.fromDoc(doc));
    }

    Comparator<Message> timestampComparator =
        (a, b) => b.timestamp!.compareTo(a.timestamp!);
    messages.sort(timestampComparator);
    return messages;
  }

  void sendChatMessage(Message message) {
    chatsRef.add({
      'senderId': message.senderId,
      'toUserId': message.toUserId,
      'text': message.text,
      'imageUrl': message.imageUrl,
      'isLiked': message.isLiked,
      'unread': message.unread,
      'timestamp': Timestamp.fromDate(DateTime.now()),
    });
  }
```

#### Update Message Model

We need to update our message model and introduce <!-

final Timestamp? timestamp;

also it will have a function that maps database values with object.

```
import 'package:cloud_firestore/cloud_firestore.dart';

class Message {
  final String? id, senderId, toUserId, text, imageUrl;
  final bool? isLiked;
  final bool? unread;
  final Timestamp? timestamp;

  Message({
    this.id,
    this.senderId,
    this.toUserId,
    this.text,
    this.imageUrl,
    this.isLiked,
    this.unread,
    this.timestamp,
  });

  factory Message.fromDoc(DocumentSnapshot doc) {
    return Message(
        id: doc.id,
        senderId: doc['senderId'],
        toUserId: doc['toUserId'],
        text: doc['text'],
        imageUrl: doc['imageUrl'],
        isLiked: doc['isLiked'],
        unread: doc['unread'],
        timestamp: doc['timestamp']);
  }
}

```

We will add dateFormat to our constants.dart ðŸ“„ file

To get the dateformat import package - intl - pubspec.yaml

> **`intl: ^0.17.0`**

```
final DateFormat timeFormat = DateFormat('E, h:mm a');
```



#### Refactor Chat Screen

That chat_screen.dart will need to take 2 parameters, from which **user message** is coming from and to sender.

```
 final String currentUserId;
  final AppUser toUser;

  const ChatScreen(
      {required this.currentUserId, required this.toUser, Key? key})
      : super(key: key);
  @override
  _ChatScreenState createState() => _ChatScreenState();
}
```

We need to bring messages from our database. so remove   reference to dummy data 

```
List<Message> _messages = [];
```

`And add database service , also that needs to be initialized ` , create a private function to process through the messages and initialize the message list

```
List<Message> _messages = [];
  late DatabaseService _databaseService;
 @override
  void initState() {
    super.initState();
    _databaseService = Provider.of<DatabaseService>(context, listen: false);

    _setupMessages();
  }

  _setupMessages() async {
    List<Message> messages = await _databaseService.getChatMessages(
        widget.currentUserId, widget.toUser.id!);
    setState(() {
      _messages = messages;
    });
  }
```

Update message time in the text with

```
Â Â Text(
  '${timeFormat.format(message.timestamp.toDate())}',
```

In the Â `void _handleSubmitted(String` , update code to pass new values and call the database service

```
void _handleSubmitted(String text) {
    _textMessageController.clear();

    setState(() {
      _isComposing = false;
    });
    Message message = Message(
      senderId: widget.currentUserId,
      toUserId: widget.toUser.id,
      timestamp: Timestamp.fromDate(DateTime.now()),
      text: text,
      isLiked: true,
      unread: true,
    );
    setState(() {
      _messages.insert(0, message);
    });
  }

```

And finally update the `isMe`code to get value from the widget

```
final bool isMe = message.senderId == widget.currentUserId;
```

Chat screen is called through the attendees screen.

#### Update all_attendees_widget

So update the all_attendees_widget.dart

Note : In the build get the current user id

```
  Widget build(BuildContext context) {
    String? currentUserId =
        Provider.of<UserData>(context, listen: false).currentUserId;

```

And pass it to the chatscreen , update GestureDetector

```
return GestureDetector(
                onTap: () => Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (_) => ChatScreen(
                        currentUserId: currentUserId!,
                        toUser: user,
                        ),
                  ),
                ),
```

![](https://lh4.googleusercontent.com/KrQ0Q44DBwIwR9TI3vDFWrZ8dJwtNT3NVuaPbYh_JdNEi4iNMukWLCpTP8VS5kHfPEY5fTgzIYyWorlWbpL_g4sUGqkl6LGKjdvlxJBnVD-ZWhJwaiFgBg-jiHNPd2aForffvaQ7)

## Step 6 -Sending Picture Messages

We would also like to send pictures in the chat.

In our storage_service.dart we will add a new function uploadMessageImage

```
Future<String> uploadMessageImage(File imageFile) async {

Â Â Â String imageId = Uuid().v4();

Â Â Â File image = await compressImage(imageId, imageFile);

Â 

Â Â Â String downloadUrl = await _uploadImage(

Â Â Â Â Â 'images/messages/message_$imageId.jpg',

Â Â Â Â Â imageId,

Â Â Â Â Â image,

Â Â Â );

Â Â Â return downloadUrl;

Â }
```

In chat_screen.dart we update _buildMessage

And check if message.imageurl == null and removeÂ  Text(Â  Â  Â  Â  Â  Â  Â  message.text, â€¦

```
Â Â Â children: <Widget>[

Â Â Â Â Â Â Â Â Â Â Â message.imageUrl == null

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ? _buildText(isMe, message)

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â : _buildImage(context, message),

Â Â Â Â Â Â Â Â Â Â Â SizedBox(height: 8.0),
```

Add the new methods before build

```
_buildText(bool isMe,Message message) {

Â Â Â return Text(

Â Â Â Â Â Â Â Â Â Â Â Â Â message.text,

Â Â Â Â Â Â Â Â Â Â Â Â Â style: TextStyle(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â color: isMe ? Colors.white60 : Colors.blueGrey,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fontSize: 12.0,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fontWeight: FontWeight.w600,

Â Â Â Â Â Â Â Â Â Â Â Â Â ),

Â Â Â Â Â Â Â Â Â Â Â );

Â }

_buildImage(BuildContext context,Message message) {

Â Â Â final size = MediaQuery.of(context).size;

Â Â Â return Container(

Â Â Â Â Â height: size.height * 0.2,

Â Â Â Â Â width: size.width * 0.6,

Â Â Â Â Â decoration: BoxDecoration(

Â Â Â Â Â Â Â Â Â borderRadius: BorderRadius.circular(20.0),

Â Â Â Â Â Â Â Â Â image: DecorationImage(

Â Â Â Â Â Â Â Â Â Â Â fit: BoxFit.cover,

Â Â Â Â Â Â Â Â Â Â Â image: CachedNetworkImageProvider(message.imageUrl),

Â Â Â Â Â Â Â Â Â )),

Â Â Â );

Â }
```

Add to onPressed of our camera icon

```
children: <Widget>[

Â Â Â Â Â Â Â Â Â RawMaterialButton(

Â Â Â Â Â Â Â Â Â Â Â onPressed: () async {

Â Â Â Â Â Â Â Â Â Â Â Â Â File imageFile = await ImagePicker.pickImage(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â source: ImageSource.gallery,

Â Â Â Â Â Â Â Â Â Â Â Â Â );

Â Â Â Â Â Â Â Â Â Â Â Â Â if (imageFile != null) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â String imageUrl =

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await Provider.of<StorageService>(context, listen: false)

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .uploadMessageImage(imageFile);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _handleSubmitted(null, imageUrl);

Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â },
```

Update _handleSubmitted to take additional parameter

```
void _handleSubmitted(String text, String imageUrl) {

Â Â Â if ((text != null && text.trim().isNotEmpty) || imageUrl != null) {

Â Â Â Â Â if (imageUrl == null) {

Â Â Â Â Â Â Â //text message

Â 

Â Â Â Â Â Â Â setState(() {

Â Â Â Â Â Â Â Â Â _isComposing = false;

Â Â Â Â Â Â Â });

Â Â Â Â Â }

Â Â Â Â Â Message message = Message(

Â Â Â Â Â Â Â senderId: widget.currentUserId,

Â Â Â Â Â Â Â toUserId: widget.toUserId,

Â Â Â Â Â Â Â imageUrl: imageUrl,

Â Â Â Â Â Â Â timestamp: Timestamp.fromDate(DateTime.now()),

Â Â Â Â Â Â Â text: text,

Â Â Â Â Â Â Â isLiked: true,

Â Â Â Â Â Â Â unread: true,

Â Â Â Â Â );

Â Â Â Â Â setState(() {

Â Â Â Â Â Â Â _messages.insert(0, message);

Â Â Â Â Â });

Â Â Â Â Â _dataBaseService.sendChatMessage(message);

Â Â Â }

Â }
```

Â And update its usages.

```
onPressed: _isComposing

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ? () => _handleSubmitted(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _textMessageController.text,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â null,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â : null,
```

Finally add Provider for StorageService in main.dart

```
Provider<StorageService>(

Â Â Â Â Â create: (_) => StorageService(),

Â Â Â ),
```